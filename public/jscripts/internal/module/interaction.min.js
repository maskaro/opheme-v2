
var intervalSec=30,interactionDiv="#interactions",max_length=140,loadMaxOld=10,clock=$("#countdown"),clockInterval,clockCounter;function showInteractions(b,i,e){if(b.length===0){return[]}var g=0,f=0;do{var n,p,k,h,o,c,j,d,l,m,a;if(e){n=b.shift()}else{n=b.pop()}d=n.sm_user_id;l=n.sm_user_screen_name;m=n.authKeyType;j="<a href='https://"+m+".com/"+l+"' target='_blank'>@"+l+"</a>";p=$("<div></div>").attr("id","row_"+b.length).addClass("smInteractionRow");o=$("<img/>").addClass("img-responsive").attr("src","/images/map/"+m+"_icon.png");switch(n.type){case"follow_out":h=$("<i></i>").addClass("fa fa-hand-o-right");k=$("<div>Followed "+j+"</div>").addClass("smInteraction-message");a=n.added_at;break;case"follow_in":h=$("<i></i>").addClass("fa fa-hand-o-left");k=$("<div>"+j+" is following you</div>").addClass("smInteraction-message");a=n.added_at;break;case"message_out":h=$("<i></i>").addClass("fa fa-comments");k=$("<div>Messaged "+j+"</div>").addClass("smInteraction-message");a=n.added_at;break;case"message_in":h=$("<i></i>").addClass("fa fa-comments");k=$("<div>"+j+" replied to your message</div>").addClass("smInteraction-message");a=n.added_at;break;case"favourite_out":h=$("<i></i>").addClass("fa fa-star");k=$("<div>Favourited "+j+"'s message</div>").addClass("smInteraction-message");a=n.added_at;break;case"favourite_in":h=$("<i></i>").addClass("fa fa-star");k=$("<div>"+j+" favourited your message</div>").addClass("smInteraction-message");a=n.added_at;break;default:break}c=$("<span>"+timeConverter(a)+"</span>").addClass("smInteraction-time");p.append(h);p.append(o);p.append(k);p.append(c);p.addClass("activate");if(a>=lastActionTime&&n.type.indexOf("_out")===-1){p.addClass("alert-info");f++}p.click({a:d,b:l,c:m,x:"#row_"+b.length},clickThis);if(e){$(i).append(p)}else{$(i).prepend(p)}}while(++g<loadMaxOld&&b.length>0);return b}function clickThis(b){getConversation(b.data.a,b.data.b,b.data.c);var a=parseInt($("#wizard-menu-smInteraction .badge").html());if(a>0){$("#wizard-menu-smInteraction .badge").html((a-1))}if($(b.data.x).hasClass("alert-info")){$(b.data.x).removeClass("alert-info");$("#wizard-menu-smInteraction .badge").html((parseInt($("#wizard-menu-smInteraction .badge").html())-1));if(parseInt($("#wizard-menu-smInteraction .badge").html())===0){$("#wizard-menu-smInteraction .badge").removeClass("alert-danger")}}}function getConversation(b,a,c){var d={userId:_oUserId,smUid:b,sortType:"asc",type:"message"};$.ajax({async:true,type:"POST",cache:false,dataType:"json",url:"/ajax/socialMedia/getInteraction",data:d}).done(function(e){if(e instanceof Array&&e.length>0){setupConversation(e,a,c)}})}function setupConversation(a,d,g){if(a.length===0){return}$("#conversation-view").remove();var f="<a href='https://"+g+".com/"+d+"' target='_blank'>@"+d+"</a>";var b=$("<div></div>").attr("id","conversation-view").addClass("modal fade in").attr("style","display: block").attr("aria-hidden","false").append($("<div></div").addClass("modal-dialog").append($("<div></div").addClass("modal-content").append($("<div></div").addClass("modal-header").append($("<button></button>").attr("type","button").addClass("close").click(function(){$("#conversation-view").modal("hide")}).append($("<span></span>").attr("aria-hidden","true").html("x")).append($("<span></span>").addClass("sr-only").html("Close"))).append($("<h4></h4>").addClass("modal-title").html("Conversation with "+f+""))).append($("<div></div").addClass("modal-body"))));var c=b.find(".modal-body");var i=$("<div></div>").addClass("message message-sent").append($("<span>"+f+" - "+timeConverter(a[0].original_message_added_at)+"</span>")).append($("<p>"+a[0].original_message+"</p>")).appendTo(c);do{var h=a.shift();var i=$("<div></div>").addClass("message");var e=$("<p>"+Autolinker.link(h.message,{twitter:false})+"</p>");if(parseInt(h.favourited)===1){e.append($("<i></i>").addClass("fa fa-star").attr("style","color: yellow; float: right; font-size: 16px;").attr("title","Favourited"))}switch(h.type){case"message_in":i.append($("<span></span>").append(f+" - "+timeConverter(h.message_added_at)));i.append(e);i.addClass("message-sent");break;case"message_out":i.append($("<span></span>").attr("style","display: block").append("You - "+timeConverter(h.message_added_at)));i.append(e);i.append($("<div></div>").addClass("clearfix"));i.addClass("message-received");break;default:break}c.append(i)}while(a.length>0);c.append($("<br>")).append($("<label></label>").addClass("control-label").append("Reply: (Characters left: <span id='countReplyChars'>Unlimited</span>)")).append($("<textarea></textarea>").append("@"+d+" ").addClass("form-control").attr("rows",3).attr("id","replyText").on("input change",function(){var j=$(this);if(g==="twitter"){if(j.val().length>max_length){j.val(j.val().substr(0,max_length))}else{}$("#countReplyChars").html(max_length-j.val().length)}else{}})).append($("<button></button>").append($("<i></i>").addClass("fa fa-reply")).append("&nbsp;Reply").attr("type","button").addClass("btn btn-primary").attr("style","margin-right: 5px").click(function(){var j={oUserId:_oUserId,smType:h.authKeyType,smId:h.authKeyId,message:$("#replyText").val(),usn:d,uId:h.sm_user_id,mId:h.message_id,origMsg:h.message,origMsgDate:h.message_added_at,fromInteraction:true};$.ajax({async:true,type:"POST",cache:false,dataType:"json",url:"/ajax/socialMedia/sendReply",data:j}).done(function(m){$("#conversation-view").modal("hide");var l,k;if(m===true){k="success";l="Message has been successfully sent!"}else{k="danger";l="Message has not been sent. Reason: "+m+"."}displayAlert(k,l)})})).append($("<button></button>").append($("<i></i>").addClass("fa fa-"+g)).append("&nbsp;Follow").attr("type","button").addClass("btn btn-primary").attr("style","margin-right: 5px").click(function(){if(confirm("Are you sure you want to follow @"+d+"?")===true){var j={oUserId:_oUserId,userId:h.sm_user_id,screen_name:d,authKeyId:h.authKeyId,smType:g};$.ajax({async:true,type:"POST",cache:false,dataType:"json",url:"/ajax/socialMedia/follow",data:j}).done(function(m){$("#conversation-view").modal("hide");var l,k;if(m===true){k="success";l="User has been successfully followed!"}else{k="danger";l="User has not been successfully followed. Reason: "+m+"."}displayAlert(k,l)})}})).append($("<button></button>").append("Cancel").attr("type","button").addClass("btn btn-default").click(function(){$("#conversation-view").modal("hide")}));b.find(".modal-body").append(c);$("body").append(b);if(g==="twitter"){$("#countReplyChars").html(max_length-d.length-2)}$("#conversation-view textarea").focusTextToEnd();$("#conversation-view").modal()}function getInteraction(){var b=Math.round(new Date().getTime()/1000)-intervalSec,a={userId:_oUserId,since:b};$.ajax({async:true,type:"POST",cache:false,dataType:"json",url:"/ajax/socialMedia/getInteraction",data:a}).done(function(c){if(c instanceof Array){if(c.length>0){showInteractions(c,interactionDiv)}}else{console.log(c)}}).complete(function(){startClock(true)})}function startClock(a){if(a===true){clockInterval=setInterval(startClock,1000);clockCounter=intervalSec}$(".radial-progress").attr("data-progress",clockCounter--);if(clockCounter===0){clearInterval(clockInterval)}}function displayAlert(a,b){var c="		<div class='container msgJs'>			<div class='row'>				<div class='col-md-12'>					<div id='message-container'>						<div class='alert alert-"+a+"'>							<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>							"+b+"						</div>					</div>				</div>			</div>		</div>";$(c).insertBefore($("#smInteraction-container"))}$("#interactionsSearchBox").keyup(function(){var a=$(this).val().toLowerCase();$(".smInteractionRow").each(function(){var b=$(this),c=b.html().toLowerCase();if(a.length>0){if(c.indexOf(a)>0){b.show()}else{b.hide()}}else{b.show()}})});$("#loadMoreRows").click(function(){intResInitial=showInteractions(intResInitial,interactionDiv,true);if(intResInitial.length===0){$("#loadMoreRows").parent().remove()}});setInterval(function(){getInteraction()},intervalSec*1000);intResInitial=showInteractions(intResInitial,interactionDiv,true);if(intResInitial.length===0){$("#loadMoreRows").parent().remove()}startClock(true);